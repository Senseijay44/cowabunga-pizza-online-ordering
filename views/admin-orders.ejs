<section class="page-header">
  <h1>Admin · Orders</h1>
  <p>Lightweight kitchen view for the current sprint.</p>
</section>

<div class="admin-main">
  <% const formatCurrency = (value) => { const num = Number(value) || 0; return `$${(Math.round(num * 100) / 100).toFixed(2)}`; }; %>
  <% const describeItemType = (item) => { if (!item) return 'Item'; if (item.type) return item.type === 'custom' ? 'Custom' : item.type; return item.meta ? 'Custom' : 'Preset'; }; %>
  <% if (!orders || orders.length === 0) { %>
    <div class="admin-card admin-empty-state">
      <p>No orders yet. Go place one from the menu to see it here.</p>
    </div>
  <% } else { %>
    <section class="admin-card">
      <div class="admin-section-header">
        <div>
          <h2>Orders</h2>
          <p class="admin-section-description">Track live orders and update their status in real time.</p>
        </div>
      </div>

      <div class="admin-table-wrapper admin-table-card">
        <table class="admin-orders-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Placed At</th>
              <th>Customer</th>
              <th>Contact</th>
              <th>Type</th>
              <th>Items</th>
              <th>Status</th>
              <th>Update Status</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(order => { %>
              <tr data-order-id="<%= order.id %>">
                <td class="admin-order-id">#<%= order.id %></td>
                <td class="admin-order-date">
                  <span><%= new Date(order.createdAt).toLocaleString() %></span>
                </td>
                <td class="admin-customer">
                  <div class="admin-customer-name"><%= order.customer.name %></div>
                  <div class="admin-customer-address">
                    <% if (order.fulfillmentMethod === 'delivery') { %>
                      <strong>Delivery to:</strong> <%= order.customer.address %>
                    <% } else { %>
                      <span class="muted">Pickup</span>
                      <% if (order.customer.address) { %>
                        · <%= order.customer.address %>
                      <% } %>
                    <% } %>
                  </div>
                </td>
                <td class="admin-contact">
                  <div><%= order.customer.phone %></div>
                  <% if (order.customer.email) { %>
                    <div class="admin-contact-email"><%= order.customer.email %></div>
                  <% } %>
                </td>
                <td class="admin-fulfillment">
                  <strong><%= order.fulfillmentMethod === 'delivery' ? 'Delivery' : 'Pickup' %></strong>
                </td>
                <td class="admin-order-items">
                  <details>
                    <summary>View items (<%= Array.isArray(order.items) ? order.items.length : 0 %>)</summary>
                    <ul class="admin-order-item-list">
                      <% if (Array.isArray(order.items) && order.items.length > 0) { %>
                        <% order.items.forEach((item) => { const qty = Number(item?.qty || 0); const price = Number(item?.price || 0); const lineTotal = Math.round(price * qty * 100) / 100; %>
                          <li class="admin-order-item">
                            <div class="admin-order-item-header">
                              <div>
                                <strong><%= item?.name || 'Item' %></strong>
                                <span class="admin-order-item-type">(<%= describeItemType(item) %>)</span>
                              </div>
                              <div class="admin-order-item-line-total"><%= formatCurrency(lineTotal || price * qty) %></div>
                            </div>
                            <% if (item?.meta) { %>
                              <div class="admin-order-item-meta"><%= item.meta %></div>
                            <% } %>
                            <div class="admin-order-item-pricing">
                              <span>Qty: <%= qty %></span>
                              <span>Unit: <%= formatCurrency(price) %></span>
                              <span>Line: <%= formatCurrency(lineTotal || price * qty) %></span>
                            </div>
                          </li>
                        <% }); %>
                      <% } else { %>
                        <li class="admin-order-item muted">No items available</li>
                      <% } %>
                    </ul>
                  </details>
                </td>
                <td class="order-status-cell">
                  <%= order.status %>
                </td>
                <td>
                  <select class="order-status-select">
                    <% Object.values(STATUS).forEach(s => { %>
                      <option value="<%= s %>" <%= s === order.status ? 'selected' : '' %>>
                        <%= s %>
                      </option>
                    <% }); %>
                  </select>
                </td>
                <td class="admin-order-total">
                  <% if (order.totals && typeof order.totals.total === 'number') { %>
                    <%= formatCurrency(order.totals.total) %>
                  <% } else { %>
                    -
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </section>
  <% } %>
</div>

<script src="/js/admin-orders.js"></script>
